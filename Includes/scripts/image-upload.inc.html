<script>
function serializeAndSave() {
  const showData = document.querySelector('#btnSave');

  let d = new Date();
  let f = document.getElementById('imageFile');
  const file = f.files[0];
  const fr = new FileReader();
  let ln = document.getElementById('lastName');
  let fn = document.getElementById('firstName');
  let e = document.getElementById('emailAddress');
  let ph = document.getElementById('phoneNumber');
  let t = document.getElementById('titleOfWork');
  let w = document.getElementById('sizeWidth');
  let h = document.getElementById('sizeHeight');
  let p = document.getElementById('price');
  let m = document.getElementById('medium');
  let showId = showData.dataset.id;
  let showName = showData.dataset.name;
  let fileNameFormatted = `${ln.value}-${fn.value}-${t.value}-${m.value}-${w.value}x${h.value}-${p.value}`;
  let data = [showId, showName, fn.value, ln.value, e.value, ph.value, t.value, m.value, w.value, h.value, p.value,
    fileNameFormatted
  ];

  if (allFieldsValid()) {

    document.getElementById('messageAlert').style.display = "none";
    document.getElementById("loading").style.display = "block";
    fr.onload = function (e) {
      const obj = {
        filename: fileNameFormatted,
        mimeType: file.type,
        bytes: [...new Int8Array(e.target.result)]
      };
      google.script.run.withSuccessHandler(saveFormSuccess).saveFile(obj, data, showData.dataset.folder, showData
        .dataset.name, showId);
    };
    fr.readAsArrayBuffer(file);
  } else {
    return false;
  }

}

function saveFormSuccess(e) {
  let email = document.getElementById('emailAddress').value;
  let evtName = document.querySelector('#btnSave').dataset.name;
  google.script.run.withSuccessHandler(setSubmitsByArtist).getTotalByEventArtist(evtName, email) ;
  google.script.run.withSuccessHandler(setEntriesSubmitted).getTotalByEvent(evtName);

  let title = document.getElementById('titleOfWork').value;
  let messageContent = `Your submission: [${title}] has been saved. Would you like to submit another work?`;
  let container = document.getElementById("thumbnail-container");
  let outerBox = document.getElementById('thumbnail-outer-box');
  let messageBox = document.getElementById('thumbnail-message');

  document.getElementById("loading").style.display = "none";
  document.getElementById("messageContent").innerHTML = messageContent;
  document.getElementById('titleOfWork').value = "";
  document.getElementById('sizeWidth').value = "";
  document.getElementById('sizeHeight').value = "";
  document.getElementById('medium').value = "";
  document.getElementById('price').value = "";
  document.getElementById('imageFile').value = "";
  document.getElementById('messageAlert').style.display = "block";
  document.getElementById('thumbnail').src = "";
  container.style.display = "none";
  messageBox.style.display = "block";
  outerBox.classList.add("mraa-highlight");
  return true;
}

function showThumbnail(e) {
  let thumbnail = document.getElementById('thumbnail');
  let container = document.getElementById('thumbnail-container');
  let message = document.getElementById('thumbnail-message');
  let outerBox = document.getElementById('thumbnail-outer-box');

  outerBox.classList.remove('mraa-highlight');
  message.style.display = "none";

  thumbnail.src = URL.createObjectURL(e.target.files[0]);
  container.style.display = "block";
}

function allFieldsValid() {
  let inputs = document.querySelectorAll('input');
  let invalidCount = 0;

  inputs.forEach(function (input) {
    if (!input.validity.valid) {
      invalidCount++;
    }
  })
  return invalidCount == 0;
}

function stopSubmit(e) {
  e.preventDefault();
  return false;
}

function setSubmitsByArtist(count) {
  let countEl = document.getElementById('submitsByArtist');
  if (submitsExceedLimit(count)) {
    countEl.classList.add("badge-danger");
    countEl.classList.remove("badge-warning");
  } 
  countEl.innerText = count;  
}

function showMemberSuccess(good) {
  if (good) {
    let el = document.getElementById('memberStatus')
    el.innerText = "Welcome Exhibiting MRAA Member";
    el.classList.remove("badge-danger");
    el.classList.add("badge-success");
  } else {
    let el = document.getElementById('memberStatus')
    el.innerText = "Not a recognized Exhibiting MRAA Member Email Address";
    el.classList.remove("badge-success");
    el.classList.add("badge-danger");
  }

}

function submitsExceedLimit(submitCount) {
  let limit = document.getElementById('maxPerArtist').innerText;
  return submitCount >= limit;
}

function getEventTitle() {
  return document.getElementById('btnSave').dataset.name;
}

document.getElementById('btnSave').addEventListener('click', serializeAndSave);
document.getElementById('frmMain').addEventListener('submit', stopSubmit);
</script>